"use strict";(self.webpackChunkiobroker_admin_component_telegram=self.webpackChunkiobroker_admin_component_telegram||[]).push([["src_ParserComponent_jsx"],{87521:function(D,O,g){var T=g(4819),t=g.n(T),S=g(15854),v=g.n(S),b=g(58503),x=g.n(b),s=g(94427),w=g.n(s),f=g(59665),R=g.n(f),i=g(75606),k=g.n(i),I=Object.defineProperty,y=(d,l,a)=>l in d?I(d,l,{enumerable:!0,configurable:!0,writable:!0,value:a}):d[l]=a,_=(d,l,a)=>(y(d,typeof l!="symbol"?l+"":l,a),a),E=(d,l,a)=>new Promise((e,r)=>{var o=u=>{try{n(a.next(u))}catch(m){r(m)}},c=u=>{try{n(a.throw(u))}catch(m){r(m)}},n=u=>u.done?e(u.value):Promise.resolve(u.value).then(o,c);n((a=a.apply(d,l)).next())});const N=d=>({table:{minWidth:400},header:{fontSize:16,fontWeight:"bold"},ok:{color:"#0ba20b"},warn:{color:"#f57d1d"},error:{color:"#c42c3a"},cell:{padding:"6px 3px"},colIndex:{width:20},colName:{width:100},colUrl:{},colRegEx:{},colItem:{width:70},colRole:{width:70},colType:{width:70},colComma:{width:50},colUnit:{width:70},colSubstituteOld:{width:45},colSubstitute:{width:70},colFactor:{width:50},colOffset:{width:50},colInterval:{width:50},colButtons:{width:140,textAlign:"right"},changedRow:{backgroundColor:"#795d5d"},marginRight:{marginRight:10},item:{width:50,marginLeft:10},regex:{width:"calc(100% - 100px)"},dialog:{},testText:{width:"100%",height:150,resize:"none",backgroundColor:d.palette.mode==="dark"?"#333":"#fff",color:d.palette.mode==="dark"?"#fff":"#000"},input:{width:100},resultUpdated:{"& label":{color:d.palette.mode==="dark"?"#fff":"#000",animation:"$blink 1000ms ease-in-out"},"& input":{color:d.palette.mode==="dark"?"#fff":"#000",animation:"$blink 1000ms ease-in-out"}},"@keyframes blink":{"0%":{color:"#00FF00"},"100%":{color:d.palette.mode==="dark"?"#fff":"#000"}}});class C extends i.ConfigGeneric{constructor(l){super(l),_(this,"onObjectChange",(a,e)=>{if(!a)return;const r=JSON.parse(JSON.stringify(this.state.rules)),o=r.findIndex(c=>c.id===a);if(!e)o!==-1&&(r.splice(o,1),this.setState({rules:r}));else{if(o!==-1){if(r[o]={id:a,name:a.substring(this.namespace.length),common:{role:e.common.role,type:e.common.type,unit:e.common.unit},native:{link:e.native.link,item:e.native.item||0,regex:e.native.regex,interval:e.native.interval,substitute:e.native.substitute,substituteOld:e.native.substituteOld,offset:e.native.offset,factor:e.native.factor}},JSON.stringify(this.state.rules[o])===JSON.stringify(r[o]))return}else r.push({id:a,name:a.substring(this.namespace.length),common:{role:e.common.role,type:e.common.type,unit:e.common.unit},native:{link:e.native.link,item:e.native.item||0,regex:e.native.regex,interval:e.native.interval,substitute:e.native.substitute,substituteOld:e.native.substituteOld,offset:e.native.offset,factor:e.native.factor}});r.sort((c,n)=>c.name.localeCompare(n.name)),this.setState({rules:r})}}),_(this,"onAliveChange",(a,e)=>{a===`system.adapter.${this.namespace}alive`&&this.state.alive!==(e&&e.val||!1)&&this.setState({alive:e?e.val:!1})}),this.state={showEditDialog:null,data:JSON.parse(JSON.stringify(l.data)),rules:null,error:null,showDeleteDialog:null,testText:"Test text",testResult:"",changed:[],resultIndex:0,alive:!1},this.namespace=`${this.props.adapterName}.${this.props.instance}.`,this.testTextRef=t().createRef()}componentDidMount(){super.componentDidMount(),this.props.socket.getObjectViewSystem("state",this.namespace,`${this.namespace}\u9999`).then(l=>this.props.socket.getState(`system.adapter.${this.namespace}alive`).catch(()=>null).then(a=>{const e=Object.keys(l).map(r=>({id:r,name:r.substring(this.namespace.length),common:{role:l[r].common.role,type:l[r].common.type,unit:l[r].common.unit},native:{link:l[r].native.link,item:l[r].native.item||0,regex:l[r].native.regex,interval:l[r].native.interval,substitute:l[r].native.substitute,substituteOld:l[r].native.substituteOld,offset:l[r].native.offset,factor:l[r].native.factor}}));e.sort((r,o)=>r.name.localeCompare(o.name)),this.setState({rules:e,alive:a?a.val:!1}),this.props.socket.subscribeObject(`${this.namespace}*`,this.onObjectChange),this.props.socket.subscribeState(`system.adapter.${this.namespace}*`,this.onAliveChange)}))}componentWillUnmount(){this.props.socket.unsubscribeObject(`${this.namespace}*`,this.onObjectChange),this.props.socket.unsubscribeState(`system.adapter.${this.namespace}*`,this.onAliveChange),this.timerTest&&clearTimeout(this.timerTest),this.timerTest=null}requestData(l){this.state.alive&&this.props.socket.sendTo(`${this.props.adapterName}.${this.props.instance}`,"link",l).then(a=>{a&&(a.error?window.alert(a.error):this.setState({testText:a.text||""}))})}renderEditDialog(){if(!this.state.showEditDialog)return null;const l=this.state.showEditDialog;return t().createElement(s.Dialog,{key:"dialog",maxWidth:"lg",fullWidth:!0,open:!0,onClose:()=>{},classes:{paper:this.props.classes.dialog}},t().createElement(s.DialogTitle,null,i.I18n.t("parser_Test regex"),":",t().createElement("span",{style:{fontStyle:"italic",fontWeight:"bold",marginLeft:10}},this.state.showEditDialog.name)),t().createElement(s.DialogContent,null,t().createElement(s.Grid,{container:!0,spacing:2},t().createElement(s.Grid,{item:!0,sm:12},t().createElement(s.FormControl,{variant:"standard",className:this.props.classes.marginRight},t().createElement(s.InputLabel,null,i.I18n.t("parser_Type")),t().createElement(s.Select,{value:l.common.type||"string",onChange:a=>{const e=JSON.parse(JSON.stringify(l));e.common.type=a.target.value,this.setState({showEditDialog:e},()=>this.onTest())},variant:"standard"},t().createElement(s.MenuItem,{value:"boolean"},"boolean"),t().createElement(s.MenuItem,{value:"number"},"number"),t().createElement(s.MenuItem,{value:"string"},"string"),t().createElement(s.MenuItem,{value:"json"},"json"))),l.common.type==="number"?t().createElement(s.FormControlLabel,{control:t().createElement(s.Checkbox,{checked:l.native.substituteOld,onChange:()=>{const a=JSON.parse(JSON.stringify(l));a.native.comma=!a.native.comma,this.setState({showEditDialog:a},()=>this.onTest())}}),label:i.I18n.t("parser_Comma")}):null),t().createElement(s.Grid,{item:!0,sm:12},t().createElement(s.FormControlLabel,{title:i.I18n.t("parser_If new value is not available, let old value unchanged"),className:this.props.classes.marginRight,control:t().createElement(s.Checkbox,{checked:l.native.substituteOld,onChange:()=>{const a=JSON.parse(JSON.stringify(l));a.native.substituteOld=!a.native.substituteOld,this.setState({showEditDialog:a},()=>this.onTest())}}),label:i.I18n.t("parser_Substitute old value")}),l.native.substituteOld?null:t().createElement(s.TextField,{title:i.I18n.t("parser_If new value is not available, use this value"),className:i.Utils.clsx(this.props.classes.marginRight,this.props.classes.input),value:l.native.substitute||"",onChange:a=>{const e=JSON.parse(JSON.stringify(l));e.native.substitute=a.target.value,this.setState({showEditDialog:e},()=>this.onTest())},label:i.I18n.t("parser_Substitute value"),variant:"standard"}),l.common.type==="number"?t().createElement(s.TextField,{className:i.Utils.clsx(this.props.classes.marginRight,this.props.classes.input),value:l.native.factor||1,onChange:a=>{const e=JSON.parse(JSON.stringify(l));e.native.factor=a.target.value,this.setState({showEditDialog:e},()=>this.onTest())},variant:"standard",label:i.I18n.t("parser_Factor")}):null,l.common.type==="number"?t().createElement(s.TextField,{className:i.Utils.clsx(this.props.classes.marginRight,this.props.classes.input),value:l.native.offset||0,onChange:a=>{const e=JSON.parse(JSON.stringify(l));e.native.offset=a.target.value,this.setState({showEditDialog:e},()=>this.onTest())},label:i.I18n.t("parser_Offset"),variant:"standard"}):null),t().createElement(s.Grid,{item:!0,sm:12},t().createElement(s.TextField,{value:l.native.regex||"",onChange:a=>{const e=JSON.parse(JSON.stringify(l));e.native.regex=a.target.value,this.setState({showEditDialog:e},()=>this.onTest())},variant:"standard",className:this.props.classes.regex,label:i.I18n.t("parser_RegEx")}),t().createElement(s.TextField,{value:l.native.item||0,type:"number",onChange:a=>{const e=JSON.parse(JSON.stringify(l));e.native.item=a.target.value,this.setState({showEditDialog:e},()=>this.onTest())},variant:"standard",className:this.props.classes.item,label:i.I18n.t("parser_Item")}),t().createElement(s.Fab,{color:"primary",size:"small",onClick:()=>this.onTest(!0)},t().createElement(f.PlayArrow,null))),t().createElement(s.Grid,{item:!0,sm:12},t().createElement("textarea",{ref:this.testTextRef,className:this.props.classes.testText,value:this.state.testText,onChange:a=>this.setState({testText:a.target.value},()=>this.onTest())})),t().createElement(s.Grid,{item:!0,sm:12},t().createElement(s.TextField,{className:this.props.classes.resultUpdated,key:this.state.resultIndex,variant:"standard",label:i.I18n.t("parser_Result"),value:this.state.testResult.toString(),readOnly:!0,fullWidth:!0})))),t().createElement(s.DialogActions,null,t().createElement(s.Button,{disabled:JSON.stringify(this.state.showEditDialog)===this.state.originalRule,onClick:()=>{const a=JSON.parse(JSON.stringify(this.state.rules)),e=a.findIndex(r=>r.id===l.id);Object.assign(a[e].common,this.state.showEditDialog.common),Object.assign(a[e].native,this.state.showEditDialog.native),this.setState({showEditDialog:null,originalRule:null,rules:a},()=>this.onAutoSave(e))},color:"primary",startIcon:t().createElement(f.Save,null),variant:"contained"},i.I18n.t("ra_Save")),t().createElement(s.Button,{color:"grey",onClick:()=>this.setState({showEditDialog:null,originalRule:null}),variant:"contained",startIcon:t().createElement(f.Close,null)},i.I18n.t("ra_Cancel"))))}checkError(){const l=this.state.rules.findIndex(a=>!a.name);if(l!==-1)return l;for(let a=0;a<this.state.rules.length;a++)for(let e=a+1;e<this.state.rules.length;e++)if(this.state.rules[a].name===this.state.rules[e].name)return e;return!1}onAutoSave(l){const a=[...this.state.changed];a.includes(l)||(a.push(l),this.setState({changed:a})),this.saveTimer&&clearTimeout(this.saveTimer),this.saveTimer=setTimeout(()=>E(this,null,function*(){this.saveTimer=null;for(let e=0;e<this.state.changed.length;e++){const r=this.state.changed[e],o=this.state.rules[r];if(o.name&&!this.state.rules.find((c,n)=>c.name===o.name&&n!==r)){const c=o.id?yield this.props.socket.getObject(o.id):{common:{},native:{},type:"state"},n=JSON.parse(JSON.stringify(c));Object.assign(n.common,o.common),Object.assign(n.native,o.native),o.id!==`${this.namespace}${o.name}`?(o.id&&(yield this.props.socket.delObject(o.id)),yield this.props.socket.setObject(`${this.namespace}${o.name}`,n)):(JSON.stringify(c.common)!==JSON.stringify(n.common)||JSON.stringify(c.native)!==JSON.stringify(n.native))&&(yield this.props.socket.setObject(o.id,n))}}this.setState({changed:[]})}),1e3)}_onChange(l,a,e,r){const o=JSON.parse(JSON.stringify(this.state.rules)),c=a?"native":"common";e==="comma"&&(o[l].common.type="number"),o[l][c][e]=r,this.setState({rules:o},()=>this.onAutoSave(l))}renderRule(l,a,e,r){const o=!l.name||this.state.rules.find((n,u)=>n.name===l.name&&u!==a),c=this.props.classes.cell;return t().createElement(s.TableRow,{key:`${a}_${l.id}`,className:this.state.changed.includes(a)?this.props.classes.changedRow:""},t().createElement(s.TableCell,{className:c},a+1),t().createElement(s.TableCell,{className:c},t().createElement(s.TextField,{fullWidth:!0,value:l.name,error:!!o,onChange:n=>{const u=JSON.parse(JSON.stringify(this.state.rules));u[a].name=n.target.value;const m=this.checkError();this.setState({rules:u,error:m},()=>this.onAutoSave(a))},variant:"standard"})),t().createElement(s.TableCell,{className:c},t().createElement(s.TextField,{fullWidth:!0,disabled:o,value:l.native.link,onChange:n=>this._onChange(a,!0,"link",n.target.value),variant:"standard"})),t().createElement(s.TableCell,{className:c},t().createElement(s.TextField,{disabled:o,fullWidth:!0,value:l.native.regex,onChange:n=>this._onChange(a,!0,"regex",n.target.value),variant:"standard"})),t().createElement(s.TableCell,{className:c},t().createElement(s.TextField,{fullWidth:!0,disabled:o,value:l.native.item,type:"number",onChange:n=>this._onChange(a,!0,"item",n.target.value),variant:"standard"})),t().createElement(s.TableCell,{className:c},t().createElement(s.Select,{fullWidth:!0,disabled:o,value:l.common.role||"",onChange:n=>this._onChange(a,!1,"role",n.target.value),variant:"standard"},t().createElement(s.MenuItem,{value:"state"},"default"),t().createElement(s.MenuItem,{value:""},"custom"),t().createElement(s.MenuItem,{value:"temperature"},"temperature"),t().createElement(s.MenuItem,{value:"value"},"value"),t().createElement(s.MenuItem,{value:"blinds"},"blinds"),t().createElement(s.MenuItem,{value:"switch"},"switch"),t().createElement(s.MenuItem,{value:"indicator"},"indicator"))),t().createElement(s.TableCell,{className:c},t().createElement(s.Select,{fullWidth:!0,disabled:o,value:l.common.type||"string",onChange:n=>this._onChange(a,!1,"type",n.target.value),variant:"standard"},t().createElement(s.MenuItem,{value:"boolean"},"boolean"),t().createElement(s.MenuItem,{value:"number"},"number"),t().createElement(s.MenuItem,{value:"string"},"string"),t().createElement(s.MenuItem,{value:"json"},"json"))),e?t().createElement(s.TableCell,{className:c},l.common.type==="number"?t().createElement(s.Checkbox,{disabled:o,checked:!!l.native.comma,onChange:n=>this._onChange(a,!0,"comma",n.target.checked)}):null):null,e?t().createElement(s.TableCell,{className:c},t().createElement(s.TextField,{fullWidth:!0,disabled:o,value:l.common.unit,onChange:n=>this._onChange(a,!1,"unit",n.target.value),variant:"standard"})):null,t().createElement(s.TableCell,{className:c,title:i.I18n.t("parser_If new value is not available, let old value unchanged")},t().createElement(s.Checkbox,{disabled:o,checked:l.native.substituteOld,onChange:n=>this._onChange(a,!0,"substituteOld",n.target.checked)})),r?t().createElement(s.TableCell,{title:i.I18n.t("parser_If new value is not available, use this value"),className:c},l.native.substituteOld?null:t().createElement(s.TextField,{disabled:o,fullWidth:!0,value:l.native.substituteOld?"":l.native.substitute,onChange:n=>this._onChange(a,!0,"substitute",n.target.value),variant:"standard"})):null,e?t().createElement(s.TableCell,{className:c},l.common.type==="number"?t().createElement(s.TextField,{disabled:o,fullWidth:!0,value:l.native.factor,onChange:n=>this._onChange(a,!0,"factor",n.target.value),variant:"standard"}):null):null,e?t().createElement(s.TableCell,{className:c},l.common.type==="number"?t().createElement(s.TextField,{disabled:o,fullWidth:!0,value:l.native.offset,onChange:n=>this._onChange(a,!0,"offset",n.target.value),variant:"standard"}):null):null,t().createElement(s.TableCell,{title:i.I18n.t("parser_Leave it empty if default interval is desired"),className:c},t().createElement(s.TextField,{disabled:o,fullWidth:!0,value:l.native.interval,type:"number",onChange:n=>this._onChange(a,!0,"interval",n.target.value),variant:"standard"})),t().createElement(s.TableCell,{className:c},t().createElement(s.IconButton,{size:"small",disabled:o,onClick:()=>this.setState({showEditDialog:JSON.parse(JSON.stringify(this.state.rules[a])),originalRule:JSON.stringify(this.state.rules[a])},()=>this.requestData(this.state.rules[a].native.link))},t().createElement(f.Edit,null)),t().createElement(s.IconButton,{size:"small",onClick:()=>this.setState({showDeleteDialog:a})},t().createElement(f.Delete,null)),t().createElement(s.IconButton,{size:"small",disabled:o,onClick:()=>E(this,null,function*(){const n=JSON.parse(JSON.stringify(this.state.rules[a]));let u=1,m=n.name;const p=m.match(/(\d+)$/);for(p?(m=m.replace(p[0],""),u=parseInt(p[0],10)+1):m+="_";this.state.rules.find(h=>h[this.props.schema.clone]===m+u.toString());)u++;n.name=m+u.toString(),n.id=`${this.namespace}${n.name}`,yield this.props.socket.setObject(`${this.namespace}${n.name}`,{type:"state",common:l.common,native:l.native})})},t().createElement(f.ContentCopy,null))))}renderDeleteDialog(){return this.state.showDeleteDialog===null?null:t().createElement(i.Confirm,{text:i.I18n.t("parser_Delete rule"),ok:i.I18n.t("ra_Delete"),onClose:l=>E(this,null,function*(){if(l){const a=this.state.rules[this.state.showDeleteDialog].id,e=JSON.parse(JSON.stringify(this.state.rules));e.splice(this.state.showDeleteDialog,1),this.setState({rules:e,showDeleteDialog:null},()=>E(this,null,function*(){a&&(yield this.props.socket.delObject(a))}))}else this.setState({showDeleteDialog:null})})})}onTest(l){this.timerTest&&clearTimeout(this.timerTest),this.timerTest=setTimeout(()=>{let a=this.state.testText,e=this.state.showEditDialog.native.regex,r=this.state.showEditDialog.common.type,o=this.state.showEditDialog.native.comma,c=this.state.showEditDialog.native.offset,n=this.state.showEditDialog.native.item,u=this.state.showEditDialog.native.factor,m=this.state.showEditDialog.native.substitute;e||(e=".+"),e[0]==="/"&&(e=e.substring(1,e.length-1)),m!==""&&m!==void 0&&m!==null?(m==="null"&&(m=null),r==="number"?m=parseFloat(m)||0:r==="boolean"&&(m==="true"&&(m=!0),m==="false"&&(m=!1),m=!!m)):m=void 0;try{e=new RegExp(e,n?"g":"")}catch(h){this.setState({testError:h.toString()});return}c=parseFloat(c)||0,u=parseFloat(u)||1,n=(parseFloat(n)||0)+1,n<0&&(n=1),n>1e3&&(n=1e3),a=(a||"").toString().replace(/\r\n|[\r\n]/g," ");let p;do p=e.exec(a),n--;while(n&&p);if(p){let h;const J=p[1]?p[0].indexOf(p[1]):0;r==="boolean"?h="true":(h=p.length>1?p[1]:p[0],r==="number"&&(o?(h=h.replace(/\./g,""),h=h.replace(",",".")):h=h.replace(/,/g,""),h=h.replace(/\s/g,""),h=parseFloat(h),h*=u,h+=c)),this.setState({testResult:h==null?"":h,resultIndex:this.state.resultIndex+1})}else r==="boolean"?this.setState({testResult:"false",resultIndex:this.state.resultIndex+1}):this.setState({testResult:m==null?"":m,resultIndex:this.state.resultIndex+1})},l?0:1e3)}renderItem(){if(!this.state.rules)return t().createElement(s.LinearProgress,null);const l=this.state.rules.find(r=>r.common.type==="number"),a=this.state.rules.find(r=>!r.native.substituteOld),e=this.props.classes;return t().createElement(s.TableContainer,{component:s.Paper},this.renderEditDialog(),this.renderDeleteDialog(),t().createElement(s.Table,{size:"small"},t().createElement(s.TableHead,null,t().createElement(s.TableRow,null,t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colIndex)}),t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colName)},i.I18n.t("parser_Name")),t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colUrl)},i.I18n.t("parser_URL or file name")),t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colRegEx)},i.I18n.t("parser_RegEx")),t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colItem)},i.I18n.t("parser_Item")),t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colRole)},i.I18n.t("parser_Role")),t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colType)},i.I18n.t("parser_Type")),l?t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colComma)},i.I18n.t("parser_Comma")):null,l?t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colUnit)},i.I18n.t("parser_Unit")):null,t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colSubstituteOld),title:i.I18n.t("parser_If new value is not available, let old value unchanged")},i.I18n.t("parser_Old")),a?t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colSubstitute),title:i.I18n.t("parser_If new value is not available, use this value")},i.I18n.t("parser_Subs")):null,l?t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colFactor)},i.I18n.t("parser_Factor")):null,l?t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colOffset)},i.I18n.t("parser_Offset")):null,t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colInterval),title:i.I18n.t("parser_Leave it empty if default interval is desired")},i.I18n.t("parser_Interval")),t().createElement(s.TableCell,{className:i.Utils.clsx(e.cell,e.colButtons)},t().createElement(s.Fab,{size:"small",color:"primary",onClick:()=>{const r=JSON.parse(JSON.stringify(this.state.rules));r.push({id:"",name:"",common:{role:"state",type:"string",unit:"",read:!0,write:!1},native:{link:"",item:0,regex:"",interval:"",substitute:"",substituteOld:!0,offset:0,factor:1}}),this.setState({rules:r})}},t().createElement(f.Add,null))))),t().createElement(s.TableBody,null,this.state.rules.map((r,o)=>this.renderRule(r,o,l,a)))))}}C.propTypes={socket:v().object.isRequired,themeType:v().string,themeName:v().string,style:v().object,className:v().string,data:v().object.isRequired,attr:v().string,schema:v().object,onError:v().func,onChange:v().func},O.Z=(0,b.withStyles)(N)(C)}}]);

//# sourceMappingURL=src_ParserComponent_jsx.1fcddca1.chunk.js.map